


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services that will enable you to securely administer your systems in AWS as we walk through real-world threat scenarios. Learn about the secure administration capabilities of AWS Session Manager, AWS Identity and Access Management and Amazon EC2 Instance Connect.">
      
      
        <link rel="canonical" href="https://infrastructure-identity.awssecworkshops.com/02-using-AWS-Systems-Manager-Session-Manager/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Module 2: Session Manager - Infrastructure Identity in AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-2-session-manager-30-minutes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://infrastructure-identity.awssecworkshops.com/" title="Infrastructure Identity in AWS" class="md-header-nav__button md-logo" aria-label="Infrastructure Identity in AWS">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Infrastructure Identity in AWS
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Module 2: Session Manager
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/aws-secure-access-infrastructure-identity-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-secure-access-infrastructure-identity-workshop
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://infrastructure-identity.awssecworkshops.com/" title="Infrastructure Identity in AWS" class="md-nav__button md-logo" aria-label="Infrastructure Identity in AWS">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    Infrastructure Identity in AWS
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/aws-secure-access-infrastructure-identity-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-secure-access-infrastructure-identity-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-environment-setup/" title="Module 1: Environment setup" class="md-nav__link">
      Module 1: Environment setup
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 2: Session Manager
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 2: Session Manager" class="md-nav__link md-nav__link--active">
      Module 2: Session Manager
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tasks" class="md-nav__link">
    Tasks
  </a>
  
    <nav class="md-nav" aria-label="Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-1-create-iam-roles-and-permissions-to-enable-session-manager-for-amazon-ec2-instances" class="md-nav__link">
    Task 1: Create IAM roles and permissions to enable Session Manager for Amazon EC2 Instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-setup-aws-systems-manager-to-manage-systems-on-premises" class="md-nav__link">
    Task 2: Setup AWS Systems Manager to manage systems on-premises
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-create-instances-and-install-the-ssm-agent" class="md-nav__link">
    Task 3: Create instances and install the SSM Agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-configure-systems-manager-to-enable-management-of-on-premises-systems" class="md-nav__link">
    Task 3: Configure Systems Manager to enable management of on-premises systems
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-4-create-iam-users-and-policy-restrictions-based-on-tags" class="md-nav__link">
    Task 4: Create IAM users and policy restrictions based on tags
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-5-configure-logging" class="md-nav__link">
    Task 5: Configure Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-6-confirm-appropriate-access-and-review-logs" class="md-nav__link">
    Task 6: Confirm appropriate access and review logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-using-EC2-Instance-Connect/" title="Module 3: EC2 Instance Connect" class="md-nav__link">
      Module 3: EC2 Instance Connect
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04-cleanup/" title="Module 4: Cleanup" class="md-nav__link">
      Module 4: Cleanup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tasks" class="md-nav__link">
    Tasks
  </a>
  
    <nav class="md-nav" aria-label="Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-1-create-iam-roles-and-permissions-to-enable-session-manager-for-amazon-ec2-instances" class="md-nav__link">
    Task 1: Create IAM roles and permissions to enable Session Manager for Amazon EC2 Instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-setup-aws-systems-manager-to-manage-systems-on-premises" class="md-nav__link">
    Task 2: Setup AWS Systems Manager to manage systems on-premises
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-create-instances-and-install-the-ssm-agent" class="md-nav__link">
    Task 3: Create instances and install the SSM Agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-configure-systems-manager-to-enable-management-of-on-premises-systems" class="md-nav__link">
    Task 3: Configure Systems Manager to enable management of on-premises systems
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-4-create-iam-users-and-policy-restrictions-based-on-tags" class="md-nav__link">
    Task 4: Create IAM users and policy restrictions based on tags
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-5-configure-logging" class="md-nav__link">
    Task 5: Configure Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-6-confirm-appropriate-access-and-review-logs" class="md-nav__link">
    Task 6: Confirm appropriate access and review logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-secure-access-infrastructure-identity-workshop/edit/master/docs/02-using-AWS-Systems-Manager-Session-Manager.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-2-session-manager-30-minutes">Module 2: Session Manager ~ 30 minutes</h1>
<p>We were given the task to setup secure administrative access to our instances but we know that anytime someone logs into a system changes can be made and those changes could inadvertently affect the security of the host. Instead of hoping our system security doesn't change, let's ensure all changes introduced into production are treated like a code release which go through our standard deployment pipeline, this pipeline includes appropriate security and configuration checks as well as code reviews. Given this change to our process we will restrict all access into production systems. This approach to administrative access is called <em>Immutable Infrastructure</em>, which includes managing services and software deployments on IT resources wherein components are replaced rather than changed. An application or service is effectively redeployed each time changes are required. Given this is a new access pattern for our team, we will continue to allow access to our development systems. Using Amazon Systems Manager Session Manager and AWS IAM with tag based permissions we will implement this exact scenario and review the audit logs.</p>
<p>In this Module we will create IAM roles with permissions to enable Session Manager access. Additionally, we are going to deploy 4 systems:</p>
<ul>
<li>AWS EC2 Instance tagged with development</li>
<li>AWS EC2 Instance tagged with production</li>
<li>Mock on-premises system tagged with development</li>
<li>Mock on-premises system tagged with production</li>
</ul>
<p>Please note our mock on-premises systems will be EC2 instances, however we will treat them like on-premises systems by not assigning an Instance Profile.</p>
<div class="admonition terminology">
<p class="admonition-title">Terminology</p>
<p>A <em>managed instance</em> is any machine configured for AWS Systems Manager. You can configure Amazon EC2 instances or on-premisess machines in a hybrid environment as a <em>managed instance</em>. Systems Manager supports various distributions of Linux, including Raspberry Pi devices, and Microsoft Windows Server. In the AWS Management Console, any machine prefixed with "mi-" is an on-premisess server or virtual machine (VM) <em>managed instance</em>. AWS Systems Manager offers a standard-instances tier and an advanced-instances tier for servers and VMs in your hybrid environment. Advanced instances also enable you to connect to your hybrid machines by using AWS Systems Manager Session Manager. Session Manager provides interactive shell access to your instances. While this lab focuses on Session Manager which is a capability of AWS Systems Manager there are several other capabilities of AWS Systems Manager that you can take advantage of, more information about <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/features.html" target="_blank">System Manager Capabilities</a></p>
</div>
<h2 id="tasks">Tasks</h2>
<ol>
<li>Create IAM roles and permissions to enable Session Manager</li>
<li>Setup AWS Systems Manager to manage systems on-premises</li>
<li>Create instances and install the SSM Agent</li>
<li>Configure Systems Manager and enable management of on-premises systems</li>
<li>Create IAM users and policy restrictions based on tags</li>
<li>Configure logging</li>
<li>Confirm appropriate access and review logs</li>
</ol>
<h3 id="task-1-create-iam-roles-and-permissions-to-enable-session-manager-for-amazon-ec2-instances">Task 1: Create IAM roles and permissions to enable Session Manager for Amazon EC2 Instances</h3>
<p>1.Return to the <a href="https://us-east-1.console.aws.amazon.com/cloud9/home" target="_blank">AWS Cloud9</a> console and use the tab that you opened in   Module 1.</p>
<p>2.Create an instance profile:</p>
<div class="codehilite"><pre><span></span><code>aws iam create-instance-profile --instance-profile-name SSMLabProfile
</code></pre></div>


<p>3.Create the json trust policy doc to attach to the IAM role. Create a new file with the following contents, save the file name: <strong>lab-role-trust-policy.json</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;ec2.amazonaws.com&quot;</span><span class="p">},</span>
    <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>4.Create an IAM role using the trust policy above:</p>
<div class="codehilite"><pre><span></span><code>aws iam create-role --role-name SSMLabRole --assume-role-policy-document file://lab-role-trust-policy.json
</code></pre></div>


<p>5.Add the role to the instance profile:</p>
<div class="codehilite"><pre><span></span><code>aws iam add-role-to-instance-profile --role-name SSMLabRole --instance-profile-name SSMLabProfile
</code></pre></div>


<p>6.Attach the existing <strong>EC2RoleSSMAccess</strong> to the newly created instance-profile:</p>
<div class="codehilite"><pre><span></span><code>aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM --role-name SSMLabRole
</code></pre></div>


<p>7.Create the json trust policy doc to attach to the IAM role. Create a new file with the following contents, save the file name: <strong>ssmservice-trust-policy.json</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;ssm.amazonaws.com&quot;</span><span class="p">},</span>
    <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>8.Create a new role named <strong>SSMServiceRole</strong> and attach the trust policy you created in the previous step:</p>
<div class="codehilite"><pre><span></span><code>aws iam create-role --role-name SSMServiceRole --assume-role-policy-document file://ssmservice-trust-policy.json
</code></pre></div>


<p>9.As a starting point, we will use AmazonSSMManagedInstanceCore to grant permission for Systems Manager to interact with your instances. AmazonSSMManagedInstanceCore, enables an instance to use AWS Systems Manager service core functionality. Depending on your operations plan, you might need permissions represented in one or more of the other three policies. To view this policy in the console go to services, IAM, Access Management, Policies and search for the <strong>AmazonSSMManagedInstanceCore</strong> policy, click on the policy, view the permissions by clicking on the permissions tab. Now attach this policy to the role using attach-role-policy command.</p>
<div class="codehilite"><pre><span></span><code>aws iam attach-role-policy --role-name SSMServiceRole --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
</code></pre></div>


<p>10.Let's make sure we allow our on-premises systems to write to CloudWatchLogs so that we can use the same Audit and Logging tools to review administrative access. We'll use the same Attach-role-policy to attach a policy that enables the SSMServiceRole to write to CloudWatchLogs.</p>
<div class="codehilite"><pre><span></span><code>aws iam attach-role-policy --role-name SSMServiceRole --policy-arn arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
</code></pre></div>


<p>11.Let's confirm all the correct policies are attached to our role. Run the following command.</p>
<div class="codehilite"><pre><span></span><code>aws iam list-attached-role-policies --role-name SSMServiceRole
</code></pre></div>


<p>The result should return the following:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">    &quot;AttachedPolicies&quot;: [</span>
<span class="err">        {</span>
<span class="err">            &quot;PolicyName&quot;: &quot;CloudWatchAgentServerPolicy&quot;,</span>
<span class="err">            &quot;PolicyArn&quot;: &quot;arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy&quot;</span>
<span class="err">        },</span>
<span class="err">        {</span>
<span class="err">            &quot;PolicyName&quot;: &quot;AmazonSSMManagedInstanceCore&quot;,</span>
<span class="err">            &quot;PolicyArn&quot;: &quot;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&quot;</span>
<span class="err">        }</span>
<span class="err">    ]</span>
<span class="err">}</span>
</code></pre></div>


<p>12.Let's also confirm the trust policy is correct. We want to confirm that for the Principal in the AssumeRolePolicyDocument is <strong>"Service":"ssm.amazonaws.com"</strong>, which allows the AWS Systems Manager Service the permissions granted in the policies we attached and listed in the previous steps. Run the following command:</p>
<div class="codehilite"><pre><span></span><code>aws iam get-role --role-name SSMServiceRole
</code></pre></div>


<p>The result should return the following:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">    &quot;Role&quot;: {</span>
<span class="err">        &quot;AssumeRolePolicyDocument&quot;: {</span>
<span class="err">            &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class="err">            &quot;Statement&quot;: [</span>
<span class="err">                {</span>
<span class="err">                    &quot;Action&quot;: &quot;sts:AssumeRole&quot;,</span>
<span class="err">                    &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="err">                    &quot;Principal&quot;: {</span>
<span class="err">                        &quot;Service&quot;: &quot;ssm.amazonaws.com&quot;</span>
<span class="err">                    }</span>
<span class="err">                }</span>
<span class="err">            ]</span>
<span class="err">        },</span>
<span class="err">        &quot;MaxSessionDuration&quot;: 3600,</span>
<span class="err">        &quot;RoleId&quot;: &quot;AROATXJRVGL4QLCVNGI77&quot;,</span>
<span class="err">        &quot;CreateDate&quot;: &quot;2020-03-03T14:59:37Z&quot;,</span>
<span class="err">        &quot;RoleName&quot;: &quot;SSMServiceRole&quot;,</span>
<span class="err">        &quot;Path&quot;: &quot;/&quot;,</span>
<span class="err">        &quot;RoleLastUsed&quot;: {},</span>
<span class="err">        &quot;Arn&quot;: &quot;arn:aws:iam::256191574777:role/SSMServiceRole&quot;</span>
<span class="err">    }</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="task-2-setup-aws-systems-manager-to-manage-systems-on-premises">Task 2: Setup AWS Systems Manager to manage systems on-premises</h3>
<p>The activation process provides an Activation Code and ID which functions like an access key ID and secret key to provide secure access to the Systems Manager service from your <em>managed instances</em>.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If you've been using the Cloud9IDE in this lab please continue to run these commands from there.</p>
</div>
<p>1.In your Cloud9IDE, using the same tab, create a managed-instance activation for your Dev instance, copy the "activation-code" and "activation-id" and label it as <strong>DevOnPrem</strong> in your scratch pad, we will use it later.</p>
<div class="codehilite"><pre><span></span><code>aws ssm create-activation --default-instance-name DevOnPrem --iam-role SSMServiceRole --registration-limit <span class="m">10</span> --region us-east-1
</code></pre></div>


<p>2.Create a managed-instance activation for your Prod instance, copy the "activation-code" and "activation-id" and label it as <strong>ProdOnPrem</strong> in your scratch pad, we will use it later.</p>
<div class="codehilite"><pre><span></span><code>aws ssm create-activation --default-instance-name ProdOnPrem --iam-role SSMServiceRole --registration-limit <span class="m">10</span> --region us-east-1
</code></pre></div>


<p><strong>Store the managed-instance Activation Code and Activation ID in a safe place.</strong> You specify this Code and ID when you install SSM Agent on systems on-premises. The code and ID combination functions like an Amazon EC2 access key ID and secret key to provide secure access to the Systems Manager service from your <em>managed instances</em>.</p>
<blockquote>
<p>If you lose the Code and ID, you must create a new activation. An activation expiration is a window of time when you can register on-premises machines with Systems Manager, default is 24 hours. An expired activation has no impact on your servers or virtual machines (VMs) that you registered with Systems Manager. This means that if an activation expires then you can’t register more servers or VMs with Systems Manager by using that specific activation code. You simply need to create a new one. All of the servers and VMs that you registered will continue to be registered Systems Manager <em>managed instances</em> until you remove or disable SSM Agent on the server or VM and thereby unregister it. <a href="https://docs.aws.amazon.com/cli/latest/reference/ssm/create-activation.html" target="_blank">For more details:</a></p>
</blockquote>
<h3 id="task-3-create-instances-and-install-the-ssm-agent">Task 3: Create instances and install the SSM Agent</h3>
<p>Please note that in order to create a mock on-premises system we need to create and use key-pair for initial access to install the Systems Manager agent. We do not need a key pair for the AWS EC2 instances because we are using Session Manager to gain direct access.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If you are using Cloud9, please perform the following on the Cloud9 instance.</p>
</div>
<p>1.Create a key pair for SSH access to the on-premises systems. Choose a key name that you can remember, and replace MyKeyPair with that name.</p>
<div class="codehilite"><pre><span></span><code>aws ec2 create-key-pair --key-name MyKeyPair --query <span class="s1">&#39;KeyMaterial&#39;</span> --output text &gt; MyKeyPair.pem
</code></pre></div>


<p>2.Update the permissions on the private key file so that only you can read it.</p>
<div class="codehilite"><pre><span></span><code>chmod <span class="m">400</span> MyKeyPair.pem
</code></pre></div>


<p>3.Copy the name of your key pair to your scratch pad.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>What is a Key Pair?</p>
<p>Amazon EC2 uses public key cryptography to encrypt and decrypt login information. Public key cryptography uses a public key to encrypt a piece of data, and then the recipient uses the private key to decrypt the data. The public and private keys are known as a key pair. Public key cryptography enables you to securely access your instances using a private key instead of a password.</p>
<p>When you launch an instance, you specify the key pair. You can specify an existing key pair or a new key pair that you create at launch. At boot time, the public key content is placed on the instance in an entry within ~/.ssh/authorized_keys. To log in to your instance, you must specify the private key when you connect to the instance.</p>
</div>
<p>4.Go back to the CloudFormation Stack, copy the following to your scratchpad:</p>
<ul>
<li>Find the stack that starts with "aws-cloud9-" click on <strong>Resources</strong>, copy the ID next to the <strong>InstanceSecurityGroup</strong></li>
<li>Find the stack named "InfrastructureIdentity-Env-Setup", click on <strong>Resources</strong>, copy the ID next to <strong>PublicSubnet1</strong> to the same scratch pad</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>At this point, make sure you have captured 3 items on your scratch pad:</p>
<blockquote>
<ol>
<li>SECGROUP - the security group ID of the InstanceSecurityGroup</li>
<li>SUBNET - the subnet ID of PublicSubnet1</li>
<li>MYKEYPAIR - the name of the key pair you created.</li>
</ol>
</blockquote>
</div>
<p>5.Let's use a script to build our systems. Create a file called CreateSystems.sh. Copy the items from your scratch pad and replace them in the file you just created.</p>
<div class="codehilite"><pre><span></span><code><span class="err">#!/bin/bash</span>

<span class="err">##</span> <span class="err">update</span> <span class="err">with</span> <span class="err">your</span> <span class="err">subnet</span>
<span class="err">SUBNET=</span><span class="s2">&quot;subnet-xxxx&quot;</span>
<span class="err">##</span> <span class="err">update</span> <span class="err">with</span> <span class="err">your</span> <span class="err">security</span> <span class="err">group</span>
<span class="err">SECGROUP=</span><span class="s2">&quot;sg-xxxx&quot;</span>
<span class="err">##</span> <span class="err">update</span> <span class="err">with</span> <span class="err">your</span> <span class="err">own</span> <span class="err">key</span>
<span class="err">MYKEYPAIR=</span><span class="s2">&quot;MyKeyPairxxxx&quot;</span>
<span class="err">##update</span> <span class="err">with</span> <span class="err">your</span> <span class="err">region</span>
<span class="err">REGION=</span><span class="s2">&quot;us-east-1&quot;</span>

<span class="err">#---no</span> <span class="err">need</span> <span class="err">to</span> <span class="err">modify</span> <span class="err">below----</span>
<span class="err">##</span> <span class="err">Create</span> <span class="err">the</span> <span class="err">Production</span> <span class="err">Ec</span><span class="mi">2</span><span class="err">Instance</span>
<span class="err">aws</span> <span class="err">ec</span><span class="mi">2</span> <span class="err">run-instances</span> <span class="err">--iam-instance-profile</span> <span class="err">Name=SSMLabProfile</span> <span class="err">--image-id</span> <span class="err">ami</span><span class="mi">-00</span><span class="mf">80e4</span><span class="err">c</span><span class="mi">5</span><span class="err">bc</span><span class="mi">078760</span><span class="err">e</span> <span class="err">--instance-type</span> <span class="err">t</span><span class="mi">1</span><span class="err">.micro</span> <span class="err">--subnet-id</span> <span class="s2">&quot;${SUBNET}&quot;</span> <span class="err">--security-group-ids</span> <span class="s2">&quot;${SECGROUP}&quot;</span> <span class="err">--associate-public-ip-address</span> <span class="err">--tag-specifications</span> <span class="err">&#39;ResourceType=instance,Tags=</span><span class="p">[{</span><span class="err">Key=</span><span class="nt">&quot;Name&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;ProdEC2Instance&quot;</span><span class="p">},{</span><span class="err">Key=</span><span class="nt">&quot;Environment&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;Prod&quot;</span><span class="p">}]</span><span class="err">&#39;</span> <span class="err">--region</span> <span class="s2">&quot;${REGION}&quot;</span>

<span class="err">##</span> <span class="err">Create</span> <span class="err">the</span> <span class="err">Development</span> <span class="err">Ec</span><span class="mi">2</span><span class="err">Instance</span>
<span class="err">aws</span> <span class="err">ec</span><span class="mi">2</span> <span class="err">run-instances</span> <span class="err">--iam-instance-profile</span> <span class="err">Name=SSMLabProfile</span> <span class="err">--image-id</span> <span class="err">ami</span><span class="mi">-00</span><span class="mf">80e4</span><span class="err">c</span><span class="mi">5</span><span class="err">bc</span><span class="mi">078760</span><span class="err">e</span> <span class="err">--instance-type</span> <span class="err">t</span><span class="mi">1</span><span class="err">.micro</span> <span class="err">--subnet-id</span> <span class="s2">&quot;${SUBNET}&quot;</span> <span class="err">--security-group-ids</span> <span class="s2">&quot;${SECGROUP}&quot;</span> <span class="err">--associate-public-ip-address</span> <span class="err">--tag-specifications</span> <span class="err">&#39;ResourceType=instance,Tags=</span><span class="p">[{</span><span class="err">Key=</span><span class="nt">&quot;Name&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;DevEC2Instance&quot;</span><span class="p">},{</span><span class="err">Key=</span><span class="nt">&quot;Environment&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;Dev&quot;</span><span class="p">}]</span><span class="err">&#39;</span> <span class="err">--region</span> <span class="s2">&quot;${REGION}&quot;</span>

<span class="err">##</span> <span class="err">Create</span> <span class="err">the</span> <span class="err">Production</span> <span class="err">on-premises</span> <span class="err">system</span>
<span class="err">aws</span> <span class="err">ec</span><span class="mi">2</span> <span class="err">run-instances</span> <span class="err">--image-id</span> <span class="err">ami</span><span class="mi">-00</span><span class="mf">80e4</span><span class="err">c</span><span class="mi">5</span><span class="err">bc</span><span class="mi">078760</span><span class="err">e</span> <span class="err">--instance-type</span> <span class="err">t</span><span class="mi">1</span><span class="err">.micro</span> <span class="err">--subnet-id</span> <span class="s2">&quot;${SUBNET}&quot;</span> <span class="err">--security-group-ids</span> <span class="s2">&quot;${SECGROUP}&quot;</span> <span class="err">--associate-public-ip-address</span> <span class="err">--key-name</span> <span class="s2">&quot;${MYKEYPAIR}&quot;</span> <span class="err">--tag-specifications</span> <span class="err">&#39;ResourceType=instance,Tags=</span><span class="p">[{</span><span class="err">Key=</span><span class="nt">&quot;Name&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;ProdOnPrem&quot;</span><span class="p">},{</span><span class="err">Key=</span><span class="nt">&quot;Environment&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;Prod&quot;</span><span class="p">}]</span><span class="err">&#39;</span> <span class="err">--region</span> <span class="s2">&quot;${REGION}&quot;</span>

<span class="err">##</span> <span class="err">Create</span> <span class="err">the</span> <span class="err">Development</span> <span class="err">on-premises</span> <span class="err">system</span>
<span class="err">aws</span> <span class="err">ec</span><span class="mi">2</span> <span class="err">run-instances</span> <span class="err">--image-id</span> <span class="err">ami</span><span class="mi">-00</span><span class="mf">80e4</span><span class="err">c</span><span class="mi">5</span><span class="err">bc</span><span class="mi">078760</span><span class="err">e</span> <span class="err">--instance-type</span> <span class="err">t</span><span class="mi">1</span><span class="err">.micro</span> <span class="err">--subnet-id</span> <span class="s2">&quot;${SUBNET}&quot;</span> <span class="err">--security-group-ids</span> <span class="s2">&quot;${SECGROUP}&quot;</span> <span class="err">--associate-public-ip-address</span> <span class="err">--key-name</span> <span class="s2">&quot;${MYKEYPAIR}&quot;</span> <span class="err">--tag-specifications</span> <span class="err">&#39;ResourceType=instance,Tags=</span><span class="p">[{</span><span class="err">Key=</span><span class="nt">&quot;Name&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;DevOnPrem&quot;</span><span class="p">},{</span><span class="err">Key=</span><span class="nt">&quot;Environment&quot;</span><span class="p">,</span><span class="err">Value=</span><span class="nt">&quot;Dev&quot;</span><span class="p">}]</span><span class="err">&#39;</span> <span class="err">--region</span> <span class="s2">&quot;${REGION}&quot;</span>
</code></pre></div>


<p>6.Change the permissions on your scripts so that only you as the owner can execute it.</p>
<div class="codehilite"><pre><span></span><code>chmod <span class="m">0755</span> CreateSystems.sh
</code></pre></div>


<p>7.Execute the script.</p>
<div class="codehilite"><pre><span></span><code>./CreateSystems.sh
</code></pre></div>


<p>8.Let's confirm that we have 4 new systems running. Go to <a href="https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Home:" target="_blank">EC2 Console</a>
Click on <strong>Running Systems</strong> you will see a list of systems. Click on each of the new systems. Notice that ProdEC2Instance and DevEC2Instance do not have Key pair names associated as we built them without a key pair and will be using Session Manager to access them. We will use the key pair only for the OnPrem systems as we need to install the SSM Agent.</p>
<ul>
<li>ProdEC2Instance</li>
<li>DevEC2Instance</li>
<li>ProdOnPrem</li>
<li>DevOnPrem</li>
</ul>
<p>9.For each instance find the <strong>private IPv4 address</strong> and copy it to your scratchpad. To find the private IPv4 address from the Amazon EC2 console check the box next to the instance, a menu with details including the Private IPs will show on the bottom of the screen, copy the Private IP address associated to that instance to your scratchpad. Do this for all 4 new systems.</p>
<p>Your scratchpad should be similar to the following:</p>
<blockquote>
<ul>
<li>ProdEC2Instance 172.20.1.x</li>
<li>DevEC2Instance 172.20.1.x</li>
<li>ProdOnPrem 172.20.1.x</li>
<li>DevOnPrem 172.20.1.x</li>
</ul>
</blockquote>
<p>10.Update the inbound rules for the Cloud9 Security Group to only allow SSH from the VPC Subnet <strong>172.20.0.0/16.</strong> From the <a href="https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Home:" target="_blank">EC2 Console</a> scroll down to <strong>NETWORK &amp; SECURITY</strong>, click on <strong>Security Groups</strong>, click the box next to the Security Group that starts with <strong>"aws-cloud9-mod-"</strong>, go to the <strong>inbound tab</strong> and click edit. Click <strong>Add Rule</strong>, Under Type select <strong>SSH</strong>, for the Source use <strong>172.20.0.0/16</strong> and add "VPC" in the description.</p>
<p>The updated inbound rules for the Security Group should look like this:
<img alt="Security Group" src="../images/SG-update.png" /></p>
<details class="info"><summary>The public address ranges already in the Security Group are the public addresses for the Cloud9 Service for the us-east-1 region, for more <a href="https://docs.aws.amazon.com/cloud9/latest/user-guide/ip-ranges.html" target="_blank">information</a>.</summary></details>
<p>11.From your Cloud9 instance ssh to the DevOnPrem instance. You specify the path and file name of the private key (.pem), the user name for your AMI, and the private ip address for the instance.</p>
<blockquote>
<p>Note: Replace MyKeyPair.pem with the name of the key-pair you created, this should be in your scratch pad. And replace 172.20.x.x with the Private IP associated with the DevOnPrem instance.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>ssh -i MyKeyPair.pem ec2-user@172.20.x.x
</code></pre></div>


<p>12.Then run the following commands to install SSM.</p>
<blockquote>
<p>Note: Replace "activation-code" and "activation-id" for the DevOnPrem instance with the code and id on your scratch pad.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>sudo yum update -Y
mkdir /tmp/ssm
curl https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm -o /tmp/ssm/amazon-ssm-agent.rpm
sudo yum install -y /tmp/ssm/amazon-ssm-agent.rpm
sudo stop amazon-ssm-agent
sudo amazon-ssm-agent -register -code <span class="s2">&quot;activation-code&quot;</span> -id <span class="s2">&quot;activation-id&quot;</span> -region us-east-1
sudo start amazon-ssm-agent
</code></pre></div>


<p>13.From your Cloud9 instance use the ssh command to connect to ProdOnPrem instance. You specify the path and file name of the private key (.pem), the user name for your AMI, and the private ip address for the instance. Additionally, you will need the private IPv4 address for your instance using the Amazon EC2 console. From the Amazon EC2 console check the box next to the ProdOnPrem instance, a menu with details including the Private IPs will show on the bottom of the screen, copy the Private IP address associated to your OnPrem instance and use it below.</p>
<blockquote>
<p>Note: Replace my-key-pair.pem with the name of the key-pair you created, this should be in your scratch pad. And replace 172.16.x.x with the Private IP associated with the ProdOnPrem instance.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>ssh -i /path/my-key-pair.pem ec2-user@172.16.x.x
</code></pre></div>


<ol>
<li>Then run the following commands to install SSM.<blockquote>
<p>Note: Replace "activation-code" and "activation-id" with the code and id on your scratch pad.</p>
</blockquote>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>sudo yum update -Y
mkdir /tmp/ssm
curl https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm -o /tmp/ssm/amazon-ssm-agent.rpm
sudo yum install -y /tmp/ssm/amazon-ssm-agent.rpm
sudo stop amazon-ssm-agent
sudo amazon-ssm-agent -register -code <span class="s2">&quot;activation-code&quot;</span> -id <span class="s2">&quot;activation-id&quot;</span> -region us-east-1
sudo start amazon-ssm-agent

<span class="nb">exit</span>
</code></pre></div>


<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>DON’T Forget the last command above, this command start the ssm agent after activation <em>- sudo start amazon-ssm-agent</em></p>
</div>
<h3 id="task-3-configure-systems-manager-to-enable-management-of-on-premises-systems">Task 3: Configure Systems Manager to enable management of on-premises systems</h3>
<p>In order to use Session Manager to connect to on-premises systems SSM needs to be configured for advanced-instances tier. To enable the advanced-instances tier:</p>
<p>1.Open the <strong>AWS Systems Manager</strong> console</p>
<p>2.In the navigation pane, choose <em>managed instances</em>.</p>
<p>3.Choose the <strong>Settings</strong> tab.</p>
<p>4.Choose <strong>Change account setting</strong>.</p>
<p>5.Review the information in the pop-up about changing account settings, and then, if you approve, choose the option to accept and click <strong>Change account setting</strong>.</p>
<details class="info"><summary>The system can take several minutes to complete the process of moving all instances from the standard-instances tier to the advanced-instances tier."</summary></details>
<p>6.Select <em>managed instances</em> You should now see a new <em>Advanced Instances</em> label next to the <em>managed instances</em> Heading and you can now manage on-premises systems.</p>
<h3 id="task-4-create-iam-users-and-policy-restrictions-based-on-tags">Task 4: Create IAM users and policy restrictions based on tags</h3>
<details class="info"><summary>The following steps require full access to IAM.</summary></details>
<p>1.If you started this lab using Cloud9, continue to run the following commands from your Cloud9 session, use the create-user command to create the user.</p>
<div class="codehilite"><pre><span></span><code>aws iam create-user --user-name MyWorkshopUser
</code></pre></div>


<p>2.Create your own and assign a password to the user by replacing the '######' symbols with that password. Please ensure you use a complex password.</p>
<div class="codehilite"><pre><span></span><code>aws iam create-login-profile --user-name MyWorkshopUser --password <span class="s1">&#39;######&#39;</span>
</code></pre></div>


<p>3.Now we will create and attach an IAM Custom Policy to MyWorkshopUser. Create a new file with the following contents, save the file name: <strong>SSMDevAccess.json</strong></p>
<blockquote>
<p>This file must reside in the same directory where your CLI session is running, or you must specify the location.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="o">{</span>
    <span class="s2">&quot;Version&quot;</span>: <span class="s2">&quot;2012-10-17&quot;</span>,
    <span class="s2">&quot;Statement&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;Effect&quot;</span>: <span class="s2">&quot;Allow&quot;</span>,
            <span class="s2">&quot;Action&quot;</span>: <span class="o">[</span>
                <span class="s2">&quot;ssm:DescribeSessions&quot;</span>,
                <span class="s2">&quot;ssm:GetConnectionStatus&quot;</span>,
                <span class="s2">&quot;ssm:DescribeInstanceProperties&quot;</span>,
                <span class="s2">&quot;ec2:DescribeInstances&quot;</span>,
                <span class="s2">&quot;ssm:StartSession&quot;</span>
            <span class="o">]</span>,
            <span class="s2">&quot;Resource&quot;</span>: <span class="s2">&quot;*&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;Sid&quot;</span>: <span class="s2">&quot;ReadAlltheSSMThings&quot;</span>,
            <span class="s2">&quot;Effect&quot;</span>: <span class="s2">&quot;Allow&quot;</span>,
            <span class="s2">&quot;Action&quot;</span>: <span class="o">[</span>
                <span class="s2">&quot;ssm:Get*&quot;</span>,
                <span class="s2">&quot;ssm:Describe*&quot;</span>,
                <span class="s2">&quot;ssm:List*&quot;</span>
            <span class="o">]</span>,
            <span class="s2">&quot;Resource&quot;</span>: <span class="s2">&quot;*&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;Sid&quot;</span>: <span class="s2">&quot;SameUserTerminate&quot;</span>,
            <span class="s2">&quot;Effect&quot;</span>: <span class="s2">&quot;Allow&quot;</span>,
            <span class="s2">&quot;Action&quot;</span>: <span class="s2">&quot;ssm:TerminateSession&quot;</span>,
            <span class="s2">&quot;Resource&quot;</span>: <span class="s2">&quot;arn:aws:ssm:*:*:session/</span><span class="si">${</span><span class="nv">aws</span><span class="p">:</span><span class="nv">username</span><span class="si">}</span><span class="s2">-*&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;Sid&quot;</span>: <span class="s2">&quot;DenySMtoProd&quot;</span>,
            <span class="s2">&quot;Effect&quot;</span>: <span class="s2">&quot;Deny&quot;</span>,
            <span class="s2">&quot;Action&quot;</span>: <span class="s2">&quot;ssm:StartSession&quot;</span>,
            <span class="s2">&quot;Resource&quot;</span>: <span class="o">[</span>
                <span class="s2">&quot;arn:aws:ec2:*:*:instance/*&quot;</span>
            <span class="o">]</span>,
            <span class="s2">&quot;Condition&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;StringLike&quot;</span>: <span class="o">{</span>
                    <span class="s2">&quot;ssm:resourceTag/Environment&quot;</span>: <span class="s2">&quot;Prod&quot;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</code></pre></div>


<p>4.Create the IAM policy using the file you just created</p>
<div class="codehilite"><pre><span></span><code>aws iam create-policy --policy-name SSMDevAccess --policy-document file://SSMDevAccess.json
</code></pre></div>


<p>The result should return the following:</p>
<div class="codehilite"><pre><span></span><code><span class="err"> {</span>
<span class="err">    &quot;Policy&quot;: {</span>
<span class="err">        &quot;PolicyName&quot;: &quot;SSMDevAccess&quot;,</span>
<span class="err">        &quot;PolicyId&quot;: &quot;ANPAJIFY55FF57L6ZEHKO&quot;,</span>
<span class="err">        &quot;Arn&quot;: &quot;arn:aws:iam::123456789012:policy/SSMDevAccess&quot;,</span>
<span class="err">        &quot;Path&quot;: &quot;/&quot;,</span>
<span class="err">        &quot;DefaultVersionId&quot;: &quot;v1&quot;,</span>
<span class="err">        &quot;AttachmentCount&quot;: 0,</span>
<span class="err">        &quot;PermissionsBoundaryUsageCount&quot;: 0,</span>
<span class="err">        &quot;IsAttachable&quot;: true,</span>
<span class="err">        &quot;CreateDate&quot;: &quot;2019-03-21T20:51:21Z&quot;,</span>
<span class="err">        &quot;UpdateDate&quot;: &quot;2019-03-21T20:51:21Z&quot;</span>
<span class="err">    }</span>
<span class="err">}</span>
</code></pre></div>


<p>5.Copy the Account ID to your scratch pad, you will need it for the next instruction. You can find the AWS Account ID located in an IAM policy ARN, between "iam" and "policy", do not include the : symbols i.e. the AWS Account ID is 123456789012 given the following ARN "Arn": <code>arn:aws:iam::123456789012:policy/SSMDevAccess</code>.</p>
<p>6.To attach the policy, use the attach-user-policy command, replace the Account ID in the policy-arn below with the Account ID in your scratchpad.</p>
<div class="codehilite"><pre><span></span><code>aws iam attach-user-policy --user-name MyWorkshopUser --policy-arn arn:aws:iam::123456789012:policy/SSMDevAccess
</code></pre></div>


<p>7.We also need to attach a policy that allows our workshop user to view the logs in CloudWatch.</p>
<div class="codehilite"><pre><span></span><code>aws iam attach-user-policy --user-name MyWorkshopUser --policy-arn  arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess
</code></pre></div>


<p>8.Let's attach a policy that allows our workshop user to view the events in CloudTrail.</p>
<div class="codehilite"><pre><span></span><code>aws iam attach-user-policy --user-name MyWorkshopUser --policy-arn arn:aws:iam::aws:policy/AWSCloudTrailReadOnlyAccess
</code></pre></div>


<p>9.Verify that the policy is attached to the user by running the list-attached-user-policies command.</p>
<div class="codehilite"><pre><span></span><code>aws iam list-attached-user-policies --user-name MyWorkshopUser
</code></pre></div>


<p>The result should return the following:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">    &quot;AttachedPolicies&quot;: [</span>
<span class="err">        {</span>
<span class="err">            &quot;PolicyName&quot;: &quot;CloudWatchLogsReadOnlyAccess&quot;,</span>
<span class="err">            &quot;PolicyArn&quot;: &quot;arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess&quot;</span>
<span class="err">        },</span>
<span class="err">        {</span>
<span class="err">            &quot;PolicyName&quot;: &quot;AWSCloudTrailReadOnlyAccess&quot;,</span>
<span class="err">            &quot;PolicyArn&quot;: &quot;arn:aws:iam::aws:policy/AWSCloudTrailReadOnlyAccess&quot;</span>
<span class="err">        },</span>
<span class="err">        {</span>
<span class="err">            &quot;PolicyName&quot;: &quot;SSMDevAccess&quot;,</span>
<span class="err">            &quot;PolicyArn&quot;: &quot;arn:aws:iam::123456789012:policy/SSMDevAccess&quot;</span>
<span class="err">        }</span>
<span class="err">    ]</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="task-5-configure-logging">Task 5: Configure Logging</h3>
<p>Session Manager provides you with options for auditing and logging session activity in your AWS account. This allows you to do the following:</p>
<blockquote>
<ul>
<li>Create and store session logs for archival purposes.</li>
<li>Generate a report showing details of every connection made to your instances using Session Manager over the past 30 days.</li>
<li>Generate notifications of session activity in your AWS account, such as Amazon Simple Notification Service (Amazon SNS) notifications.</li>
<li>Automatically initiate another action on an AWS resource as the result of session activity, such as running an AWS Lambda function, starting an AWS CodePipeline pipeline, or running an AWS Systems Manager Run Command document.</li>
</ul>
</blockquote>
<p>We will log session data using Amazon CloudWatch Logs and generate access reports.</p>
<ol>
<li>
<p>To setup Session Manager logging in Amazon CloudWatch Logs, open the <a href="https://console.aws.amazon.com/cloudwatch/" target="_blank">CloudWatch Console</a>. In the navigation pane, choose <strong>Logs</strong></p>
</li>
<li>
<p>Choose Actions, Create log group.</p>
</li>
<li>
<p>Type in the following name for the log group "SSM-Logs"</p>
</li>
<li>
<p>Now open the <a href="https://console.aws.amazon.com/systems-manager/" target="_blank">AWS Systems Manager console</a>. In the navigation pane, choose <strong>Session Manager</strong></p>
</li>
<li>
<p>Select <strong>Configure Preferences</strong> You have several configurations options, including:</p>
<blockquote>
<ul>
<li>Specify Operating System user for session</li>
<li>Enable KMS encryption for active sessions</li>
<li>Write session output to an S3 bucket</li>
<li>Send session output to CloudWatch Logs</li>
</ul>
</blockquote>
</li>
<li>
<p>Select the check box next to <strong>CloudWatch Logs</strong> and uncheck <strong>Encrypt log data</strong>.</p>
</li>
<li>
<p>Select <strong>Choose the log group name from the list</strong> specify the CloudWatch Logs group you  created <strong>SSM-Logs</strong> and select <strong>Save</strong>. Additionally, you can view ssm-agent logs on the instance here:</p>
<blockquote>
<ul>
<li>/var/log/amazon/ssm/amazon-ssm-agent.log</li>
<li>/var/log/amazon/ssm/errors.log</li>
</ul>
</blockquote>
</li>
</ol>
<h3 id="task-6-confirm-appropriate-access-and-review-logs">Task 6: Confirm appropriate access and review logs</h3>
<p>1.Go to the <a href="https://console.aws.amazon.com/iam/home?#/home" target="_blank">IAM console</a>, copy the IAM users sign-in link, it should look similar to this:
https://123456789012.signin.aws.amazon.com/console</p>
<p>2.Open a new browser and paste in the IAM users sign-in link. Sign into the AWS account as <strong>MyWorkshopUser</strong> with the password you created earlier. Go to the <a href="https://console.aws.amazon.com/systems-manager/" target="_blank">AWS Systems Manager console</a>. In the navigation pane, choose <strong>Session Manager</strong></p>
<p>3.Make sure you are in the us-east-1 region (N.Virginia). Click <strong>Start session</strong>, select the <strong>ProdOnPrem</strong> name, click on <strong>start Session</strong> and a new session windows should open for you. This demonstrates that you can manage on-premises systems with Session Manager.</p>
<p>4.In the Session Manager session type the following:</p>
<div class="codehilite"><pre><span></span><code>whoami
</code></pre></div>


<p>The result should return the following:
ssm-user</p>
<p>3.Click Terminate to end.</p>
<p>4.Repeat the steps above with DevEC2Instance, you must click <strong>Start session</strong> to see the systems. You should find the same results, the result should return the following:
ssm-user</p>
<p>5.Click <strong>Terminate</strong> to end.</p>
<p>6.Now try ProdEC2Instance, click start Session. The result should return the following:
<img alt="Session Manager Access Denied" src="../images/Denied.png" /></p>
<p>7.Go to the <strong>AWS Systems Manager</strong>, click on <strong>Session Manager</strong>, click on <strong>Session History</strong>. Your sessions should show up as Terminated or Terminating. Once the session has terminated you will see a link to <strong>CloudWatch Logs</strong>.
<img alt="Session Manager Logs in CloudWatch Logs" src="../images/SSM-Cloudwatch.png" /></p>
<p>Click on it to view the audit logs of your session, select <strong>Text</strong> on the right side of the menu. CloudWatch Logs will show details of the session such as commands that were run on the host. These logs can also be stored in S3 for you.
<img alt="Session Manager Logs in CloudWatch Logs" src="../images/CloudwatchLogs.png" /></p>
<p>8.You can also view the Session Manager events in CloudTrail as well. Go to <strong>CloudTrail</strong> and find the Event name <strong>StartSession</strong> to view the details of your Session Manager session that CloudTrail captures. You Should see something like this:
<img alt="Session Manager Logs in CloudTrail" src="../images/CloudTrail.png" /></p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>•   If your on-premises instances are showing offline, make sure the ssm-agent was re-started after the SSM activation process.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../01-environment-setup/" title="Module 1: Environment setup" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 1: Environment setup
              </div>
            </div>
          </a>
        
        
          <a href="../03-using-EC2-Instance-Connect/" title="Module 3: EC2 Instance Connect" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 3: EC2 Instance Connect
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>