



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services that will enable you to securely administer your systems in AWS as we walk through real-world threat scenarios. Learn about the secure administration capabilities of AWS Session Manager, AWS Identity and Access Management and Amazon EC2 Instance Connect.">
      
      
        <link rel="canonical" href="https://infrastructure-identity.awssecworkshops.com/03-using-EC2-Instance-Connect/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.2.0">
    
    
      
        <title>Module 3: EC2 Instance Connect - Infrastructure Identity in AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.750b69bd.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#module-3-using-amazon-ec2-instance-connect" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">

        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>

        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>

        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Infrastructure Identity in AWS
                </span>
                <span class="md-header-nav__topic">
                  Module 3: EC2 Instance Connect
                </span>
              
            
          </div>
        </div>


        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>

              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->

         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>

        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/aws-secure-access-infrastructure-identity-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-secure-access-infrastructure-identity-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link md-tabs__link--active">
        Overview
      </a>
    
  </li>

      
        
      
        
      
        
      
        
      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://infrastructure-identity.awssecworkshops.com/"
        title="Infrastructure Identity in AWS" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Infrastructure Identity
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/aws-secure-access-infrastructure-identity-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-secure-access-infrastructure-identity-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-environment-setup/" title="Module 1: Environment setup" class="md-nav__link">
      Module 1: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-using-AWS-Systems-Manager-Session-Manager/" title="Module 2: Session Manager" class="md-nav__link">
      Module 2: Session Manager
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 3: EC2 Instance Connect
      </label>
    
    <a href="./" title="Module 3: EC2 Instance Connect" class="md-nav__link md-nav__link--active">
      Module 3: EC2 Instance Connect
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tasks" title="Tasks" class="md-nav__link">
    Tasks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-1-build-an-ec2-instance-and-install-the-ec2-instance-connect-client" title="Task 1: Build an EC2 Instance and install the EC2 Instance Connect client" class="md-nav__link">
    Task 1: Build an EC2 Instance and install the EC2 Instance Connect client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-create-iam-permissions-to-enable-ec2-instance-connect" title="Task 2: Create IAM permissions to enable EC2 Instance Connect" class="md-nav__link">
    Task 2: Create IAM permissions to enable EC2 Instance Connect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-confirm-access" title="Task 3: Confirm Access" class="md-nav__link">
    Task 3: Confirm Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04-cleanup/" title="Module 4: Cleanup" class="md-nav__link">
      Module 4: Cleanup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tasks" title="Tasks" class="md-nav__link">
    Tasks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-1-build-an-ec2-instance-and-install-the-ec2-instance-connect-client" title="Task 1: Build an EC2 Instance and install the EC2 Instance Connect client" class="md-nav__link">
    Task 1: Build an EC2 Instance and install the EC2 Instance Connect client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-create-iam-permissions-to-enable-ec2-instance-connect" title="Task 2: Create IAM permissions to enable EC2 Instance Connect" class="md-nav__link">
    Task 2: Create IAM permissions to enable EC2 Instance Connect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-confirm-access" title="Task 3: Confirm Access" class="md-nav__link">
    Task 3: Confirm Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-secure-access-infrastructure-identity-workshop/edit/master/docs/03-using-EC2-Instance-Connect.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="module-3-using-amazon-ec2-instance-connect">Module 3: Using Amazon EC2 Instance Connect</h1>
<p>In the last module you used AWS Systems Manager Session Manager to securely access and administer your on-premises systems and Amazon EC2 Instances. Recently we announced a new feature that can be used for secure administration of EC2 Instances called Amazon EC2 Instance Connect. Amazon EC2 Instance Connect provides a simple and secure way to connect to your instances using Secure Shell (SSH). With EC2 Instance Connect, you use AWS Identity and Access Management (IAM) policies and principals to control SSH access to your instances, removing the need to share and manage SSH keys.</p>
<p>When you connect to an instance using EC2 Instance Connect, the Instance Connect API pushes a one-time-use SSH public key to the instance metadata where it remains for 60 seconds. The IAM policy attached to your IAM user authorizes your IAM user to push the public key to the instance metadata. The AuthorizedKeysCommand and AuthorizedKeysCommandUser, configured when Instance Connect is installed, tells the SSH daemon to look up the public key from the instance metadata for authentication, and connects you to the instance.</p>
<p>You can use Instance Connect to connect to your instances using any SSH client of your choice or the Instance Connect CLI, or you can connect to your instances by using the new browser-based SSH client in the Amazon EC2 console.</p>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-set-up.html" target="_blank">Click here for more information and a list of currently supported Operating Systems</a></p>
<h2 id="tasks">Tasks</h2>
<ol>
<li>Build an EC2 Instance and install the EC2 Instance Connect client</li>
<li>Create IAM permissions to enable EC2 Instance Connect</li>
<li>Confirm Access</li>
</ol>
<h3 id="task-1-build-an-ec2-instance-and-install-the-ec2-instance-connect-client">Task 1: Build an EC2 Instance and install the EC2 Instance Connect client</h3>
<p>EC2 Instance Connect is already installed on all versions of Amazon Linux 2, however we will use Ubuntu Server and install the client so we can become familiar with the process.</p>
<p>1.Using the same Cloud9IDE tab. Make sure your credentials are still in place on the Cloud9IDE, for additional details follow quickly configuring the AWS CLI You may need to disable AWS managed temporary credentials in Cloud9 Preference, AWS Settings, Credentials.</p>
<p>2.Create a text file named <strong>connect-install.txt</strong>, using the following contents:</p>
<div class="codehilite"><pre><span></span><span class="err">#!/bin/bash</span>
<span class="err">apt-get</span> <span class="err">update</span>
<span class="err">apt-get</span> <span class="err">install</span> <span class="err">ec</span><span class="mi">2</span><span class="err">-instance-connect</span>
<span class="err">less</span> <span class="err">/lib/systemd/system/ssh.service.d/ec</span><span class="mi">2</span><span class="err">-instance-connect.conf</span>
</pre></div>


<p>3.We will use the same SUBNET, SECGROUP and MYKEYPAIR values from Module 2 to create an Ubuntu Ec2 Instance. Create a file called <strong>CreateUbuntuSystem.sh</strong>. Copy the items from your scratch pad and replace them in the file you just created.</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">## update with your subnet</span>
<span class="nv">SUBNET</span><span class="o">=</span><span class="s2">&quot;subnet-xxxx&quot;</span>
<span class="c1">## update with your security group</span>
<span class="nv">SECGROUP</span><span class="o">=</span><span class="s2">&quot;sg-xxxx&quot;</span>
<span class="c1">## update with your own key</span>
<span class="nv">MYKEYPAIR</span><span class="o">=</span><span class="s2">&quot;MyKeyPairxxxx&quot;</span>
<span class="c1">##update with your region</span>
<span class="nv">REGION</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span>

<span class="c1">#---no need to modify below----</span>
<span class="c1">## Create the Ubuntu Instance</span>
aws ec2 run-instances --iam-instance-profile <span class="nv">Name</span><span class="o">=</span>SSMLabProfile --image-id ami-026c8acd92718196b --instance-type t1.micro --subnet-id <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUBNET</span><span class="si">}</span><span class="s2">&quot;</span> --security-group-ids <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SECGROUP</span><span class="si">}</span><span class="s2">&quot;</span> --associate-public-ip-address --tag-specifications <span class="s1">&#39;ResourceType=instance,Tags={Key=&quot;Name&quot;,Value=&quot;EC2ConnectInstance&quot;}&#39;</span> --region <span class="s2">&quot;</span><span class="si">${</span><span class="nv">REGION</span><span class="si">}</span><span class="s2">&quot;</span> --user-data file://connect-install.txt
</pre></div>


<p>4.In order to connect using the browser based EC2 Instance Connect client we need to allow inbound SSH access. You can either using the public ip of your laptop or for the purposes of the lab we can use 0.0.0.0/Update the inbound rules of the Cloud9 Security Group to now allow SSH from the the Internet 0.0.0.0/. From the <a href="https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Home:" target="_blank">EC2 Console</a> scroll down to <strong>NETWORK &amp; SECURITY</strong>, click on <strong>Security Groups</strong>, click the box next to the Security Group that starts with <strong>"aws-cloud9-mod-"</strong>, go to the <strong>inbound tab</strong> and click edit. Click <strong>Add Rule</strong>, Under Type select <strong>SSH</strong>, for the Source use <strong>0.0.0.0/0</strong> and add "EC2 Instance Connect Browser Client" in the description.</p>
<p>The updated inbound rules for the Security Group should look like this:
<img alt="Security Group" src="../images/SG-connect-update.png" /></p>
<p>4.Change the permissions on your script so that only you as the owner can execute it.</p>
<div class="codehilite"><pre><span></span>chmod <span class="m">0755</span> CreateUbuntuSystem.sh
</pre></div>


<p>5.Execute the script.</p>
<div class="codehilite"><pre><span></span>./CreateUbuntuSystem.sh
</pre></div>


<p>6.Let's confirm that we have a new system running. Go to <a href="https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Home:" target="_blank">EC2 Console</a>
Click on <strong>Running Systems</strong> you will see a list of systems. Click on the EC2ConnectInstance. Again notice that we do not have Key pair name associated as we built it without a key pair and will be using EC2 Instance Connect for access.</p>
<ul>
<li>EC2ConnectInstance</li>
</ul>
<p>7.From the previous output note the instance-id in your scratchpad, we will use it in the next section.</p>
<div class="codehilite"><pre><span></span>    <span class="s2">&quot;InstanceId&quot;</span><span class="err">:</span> <span class="s2">&quot;i-000abcdefghijklmn&quot;</span><span class="err">,</span>
</pre></div>


<h3 id="task-2-create-iam-permissions-to-enable-ec2-instance-connect">Task 2: Create IAM permissions to enable EC2 Instance Connect</h3>
<p>1.We will create and attach an IAM Customer Managed Policy to MyWorkshopUser. Create a new file with the following contents but <strong>Replace</strong> the "i-xx" with the instance-id that you noted earlier, save the file name: <strong>InstanceConnect.json</strong></p>
<blockquote>
<p>Update the <strong>Account ID</strong> and instance id (<strong>i-xx</strong>)from your scratchpad</p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;ec2-instance-connect:SendSSHPublicKey&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:ec2:us-east-1:123456789012:instance/i-xx&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Condition&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ec2:osuser&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span>
            <span class="p">}</span>
      <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;ec2:Describe*&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
    <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<blockquote>
<ul>
<li>The ec2-instance-connect:SendSSHPublicKey action grants an IAM user permission to push the public key to an instance.</li>
<li>The ec2:osuser condition specifies the default user name for the AMI that you used to launch your instance. For Amazon Linux 2, the default user name is ec2-user. For the Ubuntu AMI, the default user name is ubuntu.</li>
</ul>
</blockquote>
<p>2.Create the IAM policy using the file you just created</p>
<div class="codehilite"><pre><span></span>aws iam create-policy --policy-name InstanceConnect --policy-document file://InstanceConnect.json
</pre></div>


<p>The result should return the following:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;Policy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;PolicyName&quot;</span><span class="p">:</span> <span class="s2">&quot;InstanceConnect&quot;</span><span class="p">,</span>
        <span class="nt">&quot;PermissionsBoundaryUsageCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">&quot;CreateDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-07-23T19:58:59Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;AttachmentCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">&quot;IsAttachable&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;PolicyId&quot;</span><span class="p">:</span> <span class="s2">&quot;ANPAXMAS344KJ6Q7CGW4F&quot;</span><span class="p">,</span>
        <span class="nt">&quot;DefaultVersionId&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Path&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Arn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::abc123:policy/InstanceConnect&quot;</span><span class="p">,</span>
        <span class="nt">&quot;UpdateDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-07-23T19:58:59Z&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>3.This above command will output a policy ARN for the policy we just created. <strong>Copy</strong> the ARN value from the output and replace it in the next command.</p>
<p>4.To attach the policy, use the attach-user-policy command, and update the Account ID in the policy ARN below.</p>
<div class="codehilite"><pre><span></span>aws iam attach-user-policy --user-name MyWorkshopUser --policy-arn arn:aws:iam::abc123xxx:policy/InstanceConnect
</pre></div>


<h3 id="task-3-confirm-access">Task 3: Confirm Access</h3>
<p>1.Go to the <a href="https://console.aws.amazon.com/iam/home?#/home" target="_blank">IAM console</a>, copy the IAM users sign-in link, it should look similar to this:
https://123456789012.signin.aws.amazon.com/console</p>
<p>2.Open a new browser and paste in the IAM users sign-in link. Sign into the AWS account as <strong>MyWorkshopUser</strong> with the password you created earlier. Go to the <a href="https://console.aws.amazon.com/systems-manager/" target="_blank">AWS Systems Manager console</a>. In the navigation pane, choose <strong>Session Manager</strong></p>
<p>3.Make sure you are in the <strong>us-east-1(N.Virginia)</strong> region . Go to <strong>EC2</strong>, select <strong>Instances</strong>, select the <strong>EC2ConnectInstance</strong>. Select <strong>Connect</strong> and choose the option to <strong>connect with EC2 Instance Connect (browser-based SSH connection)</strong>. Update the user name to <strong>ubuntu</strong>. EC2 Instance Connect performs the following three actions in one call: it generates a one-time-use SSH public key, pushes the key to the instance where it remains for 60 seconds, and connects the user to the instance. You can use basic SSH/SFTP commands with the Instance Connect CLI.</p>
<p>3.You should see the EC2 Instance Connect (browser-based SSH connection) appear.</p>
<p><img alt="EC2 Instance Connection" src="../images/InstanceConnectUbuntu.png" /></p>
<blockquote>
<ul>
<li>The command “w” displays the detailed information about the users who are logged in the system currently.</li>
<li>The simple “date” command displays the current date and time (including the day of the week, month, time, time zone, year).
Enter in the following commands:</li>
</ul>
</blockquote>
<div class="codehilite"><pre><span></span>w
date
</pre></div>


<p>The results should look similar to this:</p>
<p><img alt="EC2 Instance Connect Browser" src="../images/InstanceConnectUbuntuBrowser.png" /></p>
<p>4.Now that you've seen how Session Manager and EC2 Instance Connect work.</p>
<blockquote>
<ul>
<li>What do you think?</li>
<li>What are the Pros &amp; Cons for using each?</li>
<li>What is your preference?</li>
</ul>
</blockquote>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../02-using-AWS-Systems-Manager-Session-Manager/" title="Module 2: Session Manager" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 2: Session Manager
              </span>
            </div>
          </a>
        
        
          <a href="../04-cleanup/" title="Module 4: Cleanup" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 4: Cleanup
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.39abc4af.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>